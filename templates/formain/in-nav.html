{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bootstrap demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  </head>
  <body style="background-color: #1abc9c">
    <nav class="navbar navbar-expand-lg bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand text-light text-center" href="#">My App</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto px-5">
            <li class="nav-item">
              <a
                class="nav-link active text-light"
                aria-current="page"
                href="{% url 'index' %}"
                >Home</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link text-light" href="{% url 'personal-detail' %}"
                >DashBoard</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link text-light" href="{% url 'logout' %}"
                >Logout</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- main content  -->
    {% for i in messages %}
    <div
      class="alert {{i.tags}}-warning alert-dismissible fade show w-50 mx-auto"
      role="alert"
    >
      <p class="fs-5 text-center">{{i}}</p>
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% endfor %}
    <div class="row">
      <div class="col-12">
        <div class="card mt-5 mx-2">
          <!-- /.card-header -->
          <div class="card-body">
            <a
              href="{% url 'upload-data' %}"
              class="btn btn-primary mb-3 text-light"
              >+ add</a
            >
            <div class="table-responsive">
              <!-- Added this div for responsiveness -->
              <table
                id=""
                class="table table-responsive table-bordered table-striped"
              >
                <thead>
                  <tr>
                    <th>Telegram Name</th>
                    <th>Language</th>
                    <th>Category</th>
                    <th>Level</th>
                    <th>Channel Name</th>
                    <th>Link</th>
                    <th>Total Hits</th>
                    <th>Feedback</th>
                    <th>Ratings</th>
                    <th>Total Ratings</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for data in showAllDetails %}
                  <tr>
                    <td>@{{ data.telegram_name }}</td>
                    <td>{{ data.language }}</td>
                    <td>{{ data.category.name }}</td>
                    <td>{{ data.level }}</td>
                    <td>{{ data.channel_name }}</td>
                    <td>
                      <a
                        href="{{ data.link }}"
                        target="_blank"
                        class="click-link"
                        >click</a
                      >
                    </td>
                    <td>
                      <span id="total-hits-{{ data.pk }}"
                        >{{ data.total_hits }}</span
                      >
                    </td>
                    <td>{{ data.feedback }}</td>
                    <td>{{ data.ratings }}</td>
                    <td>{{ data.total_ratings }}</td>
                    <td>
                      <div class="rating-stars" data-source-id="{{ data.pk }}">
                        <i class="star far fa-star" data-rating="1"></i>
                        <i class="star far fa-star" data-rating="2"></i>
                        <i class="star far fa-star" data-rating="3"></i>
                        <i class="star far fa-star" data-rating="4"></i>
                        <i class="star far fa-star" data-rating="5"></i>
                      </div>
                      <button
                        class="rate-button btn btn-success"
                        data-source-id="{{ data.pk }}"
                      >
                        Rate
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <th>Telegram Name</th>
                    <th>Language</th>
                    <th>Category</th>
                    <th>Level</th>
                    <th>Channel Name</th>
                    <th>Link</th>
                    <th>Total Hits</th>
                    <th>Feedback</th>
                    <th>Ratings</th>
                    <th>Total Ratings</th>
                    <th>Actions</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <!-- /.card-body -->
        </div>
      </div>
    </div>

    <!-- REQUIRED SCRIPTS -->
    <script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'plugins/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-bs4/js/dataTables.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-responsive/js/dataTables.responsive.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-responsive/js/responsive.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.bootstrap4.min.js' %}"></script>
    <script src="{% static 'plugins/jszip/jszip.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/pdfmake.min.js' %}"></script>
    <script src="{% static 'plugins/pdfmake/vfs_fonts.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.html5.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.print.min.js' %}"></script>
    <script src="{% static 'plugins/datatables-buttons/js/buttons.colVis.min.js' %}"></script>
    <script src="{% static 'dist/js/adminlte.min.js' %}"></script>
    <script src="{% static 'dist/js/demo.js' %}"></script>
    <script src="{% static 'https://code.jquery.com/jquery-3.6.0.min.js' %}"></script>

    <script>
      $(function () {
        $("#example1")
          .DataTable({
            responsive: true,
            lengthChange: false,
            autoWidth: false,
            buttons: ["copy", "csv", "excel", "pdf", "print", "colvis"],
          })
          .buttons()
          .container()
          .appendTo("#example1_wrapper .col-md-6:eq(0)");
        $("#example2").DataTable({
          paging: true,
          lengthChange: false,
          searching: false,
          ordering: true,
          info: true,
          autoWidth: false,
          responsive: true,
        });
      });
    </script>

    <script>
      $(document).ready(function () {
          $(".click-link").click(function (event) {
              event.preventDefault();
              var link = $(this).attr("href");
              var totalHitsElementId = $(this).closest("tr").find("[id^='total-hits-']").attr("id");
              var sourceId = totalHitsElementId.split("-").pop();

              $.ajax({
                  type: "GET",
                  url: "{% url 'update-total-hits' %}",
                  data: {
                      source_id: sourceId,
                      link: link,
                  },
                  success: function (data) {
                      $("#" + totalHitsElementId).text(data.total_hits);
                      window.location = link;
                  },
              });
          });

          $(".rating-stars .star").click(function () {
              var rating = parseInt($(this).data("rating"));
              var sourceId = $(this).closest("tr").find(".rating-stars").data("source-id");

              $.ajax({
                  type: "POST",
                  url: "{% url 'data' %}",
                  data: {
                      source_id: sourceId,
                      rating: rating,
                  },
                  success: function (data) {
                      $(".average-rating[data-source-id='" + sourceId + "']").text("Average Rating: " + data.average_rating);
                      $(".total-rating-count[data-source-id='" + sourceId + "']").text("Total Ratings: " + data.total_ratings);
                      $(".rating-stars[data-source-id='" + sourceId + "'] .star").each(function () {
                          var current Rating = parseInt($(this).data("rating"));
                          if (current Rating <= rating) {
                              $(this).removeClass("far").addClass("fas");
                          } else {
                              $(this).removeClass("fas").addClass("far");
                          }
                      });
                  },
              });
          });

          $(".rate-button").click(function () {
              var sourceId = $(this).data("source-id");
              var rating = $(this).closest("tr").find(".rating-stars .star.fas").length;
              if (rating === 0) {
                  // Display an alert or message indicating that a rating must be selected.
              } else {
                  $.ajax({
                      type: "POST",
                      url: "{% url 'rate-data' %}",
                      data: {
                          source_id: sourceId,
                          rating: rating,
                      },
                      success: function (data) {
                          $(".average-rating[data-source-id='" + sourceId + "']").text("Average Rating: " + data.average_rating);
                          $(".total-rating-count[data-source-id='" + sourceId + "']").text("Total Ratings: " + data.total_ratings);
                      },
                  });
              }
          });
      });
    </script>

    <!-- end main content -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
